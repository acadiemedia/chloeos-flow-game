<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChloeOS Flow Game</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      margin: 0;
      overflow: hidden;
    }
    svg {
      width: 100vw;
      height: 100vh;
    }
    .grid {
        stroke: #333;
        stroke-width: 1px;
    }
    .node {
      cursor: move;
    }
    .node-rect {
      fill: #1e1e1e;
      stroke: #bb86fc;
      stroke-width: 2px;
    }
    .node-text {
      fill: #e0e0e0;
      font-size: 14px;
      text-anchor: middle;
    }
    .port {
        fill: #fff;
        stroke: #000;
        stroke-width: 1px;
        cursor: pointer;
    }
    .connection {
        stroke: #fff;
        stroke-width: 2px;
        fill: none;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #1e1e1e;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: #fff;
        text-decoration: none;
        cursor: pointer;
    }
  </style>
</head>
<body>
  <svg id="canvas"></svg>
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Edit Node</h2>
      <form id="edit-form">
        <label for="node-name">Name:</label>
        <input type="text" id="node-name" name="name">
        <input type="hidden" id="node-id">
        <button type="submit">Save</button>
      </form>
    </div>
  </div>
  <script>
    let nodes = [
      { id: 1, name: 'InitializeSystem', x: 50, y: 50, inputs: [], outputs: ['out'] },
      { id: 2, name: 'RegisterMetaSeed', x: 50, y: 150, inputs: ['in'], outputs: ['out'] },
      { id: 3, name: 'IngestInput', x: 250, y: 50, inputs: ['in'], outputs: ['out'] },
      { id: 4, name: 'ProcessAudio', x: 450, y: 50, inputs: ['in'], outputs: ['out'] },
      { id: 5, name: 'ProcessText', x: 450, y: 150, inputs: ['in'], outputs: ['out'] },
      { id: 6, name: 'ProcessImage', x: 450, y: 250, inputs: ['in'], outputs: ['out'] },
      { id: 7, name: 'GenerateAvatar', x: 650, y: 150, inputs: ['in1', 'in2'], outputs: ['out'] },
      { id: 8, name: 'AnimateAvatar', x: 850, y: 150, inputs: ['in'], outputs: ['out'] },
      { id: 9, name: 'DeliverOutput', x: 1050, y: 150, inputs: ['in'], outputs: ['out'] },
      { id: 10, name: 'FeedbackLoop', x: 850, y: 350, inputs: ['in'], outputs: ['out'] },
    ];
    let connections = [];

    const svg = d3.select('#canvas');
    const g = svg.append('g');

    const gridSize = 20;
    const width = window.innerWidth;
    const height = window.innerHeight;

    const x = d3.scaleLinear().domain([0, width]).range([0, width]);
    const y = d3.scaleLinear().domain([0, height]).range([0, height]);

    const grid = g.append('g').attr('class', 'grid');
    grid.selectAll('.x').data(d3.range(0, width, gridSize)).enter().append('line')
        .attr('class', 'x').attr('x1', d => d).attr('y1', 0).attr('x2', d => d).attr('y2', height);
    grid.selectAll('.y').data(d3.range(0, height, gridSize)).enter().append('line')
        .attr('class', 'y').attr('x1', 0).attr('y1', d => d).attr('x2', width).attr('y2', d => d);

    const zoom = d3.zoom().scaleExtent([0.1, 8]).on('zoom', (event) => {
      g.attr('transform', event.transform);
    });
    svg.call(zoom);

    let activeConnection = null;

    function update() {
      const node = g.selectAll('.node').data(nodes, d => d.id);
      const nodeEnter = node.enter().append('g').attr('class', 'node')
        .attr('transform', d => `translate(${d.x},${d.y})`)
        .call(d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended))
        .on('dblclick', d => openModal(d.srcElement.__data__));

      nodeEnter.append('rect').attr('class', 'node-rect').attr('width', 150).attr('height', 40).attr('rx', 5).attr('ry', 5);
      nodeEnter.append('text').attr('class', 'node-text').attr('dy', 25).attr('dx', 75).text(d => d.name);

      nodeEnter.each(function(d) {
        const self = d3.select(this);
        d.inputs.forEach((input, i) => {
          self.append('circle').attr('class', 'port input').attr('r', 5).attr('cx', 0).attr('cy', 20 + i * 20);
        });
        d.outputs.forEach((output, i) => {
          self.append('circle').attr('class', 'port output').attr('r', 5).attr('cx', 150).attr('cy', 20 + i * 20)
            .on('mousedown', (event, d) => startConnection(event, d3.select(this).data()[0], i));
        });
      });

      node.select('.node-text').text(d => d.name);

      const connection = g.selectAll('.connection').data(connections);
      connection.enter().append('path').attr('class', 'connection');
      connection.attr('d', d => {
        const startNode = nodes.find(n => n.id === d.from.nodeId);
        const endNode = nodes.find(n => n.id === d.to.nodeId);
        const startPos = { x: startNode.x + 150, y: startNode.y + 20 + d.from.portIndex * 20 };
        const endPos = { x: endNode.x, y: endNode.y + 20 + d.to.portIndex * 20 };
        return `M${startPos.x},${startPos.y}C${startPos.x + 50},${startPos.y} ${endPos.x - 50},${endPos.y} ${endPos.x},${endPos.y}`;
      });
    }

    function startConnection(event, startNode, portIndex) {
      activeConnection = { from: { nodeId: startNode.id, portIndex: portIndex }, to: null };
      const line = g.append('path').attr('class', 'connection active');
      svg.on('mousemove.connection', event => {
        const [x, y] = d3.pointer(event, g.node());
        const startPos = { x: startNode.x + 150, y: startNode.y + 20 + portIndex * 20 };
        line.attr('d', `M${startPos.x},${startPos.y}L${x},${y}`);
      });
      svg.on('mouseup.connection', event => {
        const endPort = d3.select(event.target);
        if (endPort.classed('port input')) {
          const endNode = endPort.node().parentNode.__data__;
          const portIndex = Array.from(endPort.node().parentNode.querySelectorAll('.input')).indexOf(endPort.node());
          activeConnection.to = { nodeId: endNode.id, portIndex: portIndex };
          connections.push(activeConnection);
        }
        g.select('.connection.active').remove();
        activeConnection = null;
        svg.on('mousemove.connection', null).on('mouseup.connection', null);
        update();
      });
    }

    function dragstarted(event, d) { d3.select(this).raise().attr("stroke", "white"); }
    function dragged(event, d) { 
        d3.select(this).attr("transform", `translate(${event.x},${event.y})`);
        d.x = event.x;
        d.y = event.y;
        update();
    }
    function dragended(event, d) { d3.select(this).attr("stroke", null); }

    const modal = document.getElementById('edit-modal');
    const span = document.getElementsByClassName("close")[0];
    span.onclick = () => modal.style.display = "none";
    window.onclick = event => { if (event.target == modal) modal.style.display = "none"; }

    function openModal(node) {
      modal.style.display = "block";
      document.getElementById('node-name').value = node.name;
      document.getElementById('node-id').value = node.id;
    }

    document.getElementById('edit-form').onsubmit = event => {
      event.preventDefault();
      const id = document.getElementById('node-id').value;
      const name = document.getElementById('node-name').value;
      const node = nodes.find(n => n.id == id);
      node.name = name;
      modal.style.display = "none";
      update();
    }

    update();
  </script>
</body>
</html>